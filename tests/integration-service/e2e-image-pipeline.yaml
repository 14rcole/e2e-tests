apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  generateName: e2e-image-release-pipeline
spec:
  params:
    - name: release
      type: string
      description: The namespaced name (namespace/name) of the Release custom resource initiating this pipeline execution
    - name: releasePlan
      type: string
      description: The namespaced name (namespace/name) of the releasePlan
    - name: releasePlanAdmission
      type: string
      default: ""
      description: The namespaced name (namespace/name) of the releasePlanAdmission
    - name: releaseServiceConfig
      type: string
      default: ""
      description: The namespaced name (namespace/name) of the releaseServiceConfig
    - name: snapshot
      type: string
      description: The namespaced name (namespace/name) of the snapshot
    - name: releaseCatalogGitUrl
      type: string
      description: The url to the git repo where the release-service-catalog tasks to be used are stored
      default: https://github.com/konflux-ci/release-service-catalog.git
    - name: releaseCatalogGitRevision
      type: string
      description: The revision in the releaseCatalogGitUrl repo to be used
      default: staging
    - name: ociStorage
      type: string
      description: The OCI repository where the Trusted Artifacts are stored
      default: "quay.io/konflux-ci/release-service-trusted-artifacts"
    - name: trustedArtifactsDebug
      description: Flag to enable debug logging in trusted artifacts. Set to a non-empty string to enable
      type: string
      default: ""
    - name: dataDir
      description: The location where data will be stored
      type: string
      # to avoid tar extraction errors, we need to specify a subdirectory
      # inside the volume.
      default: "/var/workdir/release"
  tasks:
    - name: collect-data
      taskRef:
        resolver: "git"
        params:
          #- name: url
          #  value: $(params.releaseCatalogGitUrl)
          #- name: revision
          #  value: $(params.releaseCatalogGitRevision)
          #- name: pathInRepo
          #  value: tasks/managed/collect-data/collect-data.yaml
          - name: url
            value: "https://github.com/14rcole/e2e-tests"
          - name: revision
            value: e2e-release-pipeline
          - name: pathInRepo
            value: tests/integration-service/collect-data.yaml
      params:
        - name: release
          value: $(params.release)
        - name: releasePlan
          value: $(params.releasePlan)
        - name: releasePlanAdmission
          value: ""
        - name: releaseServiceConfig
          value: $(params.releaseServiceConfig)
        - name: snapshot
          value: $(params.snapshot)
        - name: subdirectory
          value: $(context.pipelineRun.uid)
        - name: ociStorage
          value: $(params.ociStorage)
        - name: dataDir
          value: $(params.dataDir)
        - name: trustedArtifactsDebug
          value: "$(params.trustedArtifactsDebug)"
        - name: taskGitUrl
          value: "$(params.releaseCatalogGitUrl)"
        - name: taskGitRevision
          value: "$(params.releaseCatalogGitRevision)"
    - name: reduce-snapshot # reduces snapshot only to image being released
      taskRef:
        resolver: "git"
        params:
          - name: url
            value: $(params.releaseCatalogGitUrl)
          - name: revision
            value: $(params.releaseCatalogGitRevision)
          - name: pathInRepo
            value: tasks/managed/reduce-snapshot/reduce-snapshot.yaml
      params:
        - name: SNAPSHOT
          value: $(params.dataDir)/$(tasks.collect-data.results.snapshotSpec)
        - name: SINGLE_COMPONENT
          value: true
        - name: SINGLE_COMPONENT_CUSTOM_RESOURCE
          value: snapshot/$(tasks.collect-data.results.snapshotName)
        - name: SINGLE_COMPONENT_CUSTOM_RESOURCE_NS
          value: $(tasks.collect-data.results.snapshotNamespace)
        - name: SNAPSHOT_PATH
          value: $(params.dataDir)/$(tasks.collect-data.results.snapshotSpec)
        - name: ociStorage
          value: $(params.ociStorage)
        - name: sourceDataArtifact
          value: "$(tasks.collect-data.results.sourceDataArtifact)"
        - name: dataDir
          value: $(params.dataDir)
        - name: trustedArtifactsDebug
          value: "$(params.trustedArtifactsDebug)"
        - name: taskGitUrl
          value: "$(params.releaseCatalogGitUrl)"
        - name: taskGitRevision
          value: "$(params.releaseCatalogGitRevision)"
      runAfter:
        - collect-data 
    - name: apply-mapping
      retries: 3
      taskRef:
        resolver: "git"
        params:
          - name: url
            value: $(params.releaseCatalogGitUrl)
          - name: revision
            value: $(params.releaseCatalogGitRevision)
          - name: pathInRepo
            value: tasks/managed/apply-mapping/apply-mapping.yaml
      params:
        - name: failOnEmptyResult
          value: "true"
        - name: dataPath
          value: "$(tasks.collect-data.results.data)"
        - name: snapshotPath
          value: "$(tasks.collect-data.results.snapshotSpec)"
        - name: ociStorage
          value: $(params.ociStorage)
        - name: sourceDataArtifact
          value: "$(tasks.reduce-snapshot.results.sourceDataArtifact)"
        - name: dataDir
          value: $(params.dataDir)
        - name: trustedArtifactsDebug
          value: "$(params.trustedArtifactsDebug)"
        - name: taskGitUrl
          value: "$(params.releaseCatalogGitUrl)"
        - name: taskGitRevision
          value: "$(params.releaseCatalogGitRevision)"
      runAfter:
        - reduce-snapshot
    - name: push-snapshot # pushes image and attestations to quay
      retries: 5
      when:
        - input: "$(tasks.apply-mapping.results.mapped)"
          operator: in
          values: ["true"]
      taskRef:
        resolver: "git"
        params:
          - name: url
            value: $(params.releaseCatalogGitUrl)
          - name: revision
            value: $(params.releaseCatalogGitRevision)
          - name: pathInRepo
            value: tasks/managed/push-snapshot/push-snapshot.yaml
      params:
        - name: snapshotPath
          value: "$(tasks.collect-data.results.snapshotSpec)"
        - name: dataPath
          value: "$(tasks.collect-data.results.data)"
        - name: resultsDirPath
          value: "$(tasks.collect-data.results.resultsDir)"
        - name: ociStorage
          value: $(params.ociStorage)
        - name: sourceDataArtifact
          value: "$(tasks.apply-mapping.results.sourceDataArtifact)"
        - name: dataDir
          value: $(params.dataDir)
        - name: trustedArtifactsDebug
          value: "$(params.trustedArtifactsDebug)"
        - name: taskGitUrl
          value: "$(params.releaseCatalogGitUrl)"
        - name: taskGitRevision
          value: "$(params.releaseCatalogGitRevision)"
      runAfter:
        - apply-mapping
    - name: push-build-plr # pushes the build pipelinerun yaml to quay
      description: |
        pushes the build PLR yaml to quay as an OCI artifact.  Pushes it to
        quay.io/<namespace>/$(params.image-name)-buildplr. Before pushing
        this task will sanitze the build plr yaml so that it can be reused
        by the e2e tests. The task
          - removes any statuses, labels, and annotations set by the
            integration service
          - updates the spec.containerImage field to point to the image
            pushed in the previous step
          - removes the name and namespace fields.  Replaces them with a
            generateName spec.Image field 
      taskRef:
        resolver: "git"
        params:
          - name: url
            value: "https://github.com/14rcole/e2e-tests"
          - name: revision
            value: e2e-release-pipeline
          - name: pathInRepo
            value: tests/integration-service/push-build-plr.yaml
      params:
        - name: dataPath
          value: $(params.dataDir)
        - name: snapshot
          value: $(params.snapshot)
        - name: image # TODO: parameterize this later
          value: quay.io/redhat-appstudio-qe/integration-e2e-images/konflux-test-integration
        - name: image-tag
          value: latest
        - name: quay-secret-name
          value: quay-push-pull # TODO parameterize this with releaseplan later
      #runAfter:
      #  - apply-mapping
